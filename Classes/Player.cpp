#include "Player.h"
#include "Stage.h"

USING_NS_CC;
const int FRAME_COUNT = 3;
Player::Player()
	:indexCheck(-1)
	, magicFlag(false)
	, LRMagicPosition(0,0)
	, UDMagicPosition(0, 0)
{
}

void Player::update(float dt)
{

}

bool Player::init()
{
	if (!Sprite::initWithFile("graphics/luk_sprite.png"))
	{
		return false;
	}
	cocos2d::Point PBox[8]{cocos2d::Point(-2, -12), cocos2d::Point(-4, -10), cocos2d::Point(-4, -2), cocos2d::Point(-2, 0), cocos2d::Point(2, 0), cocos2d::Point(4, -2), cocos2d::Point(4, -10), cocos2d::Point(2, -12)};
	//cocos2d::Point PBox[4]{cocos2d::Point(-4, -12), cocos2d::Point(-4, 0), cocos2d::Point(4, 0), cocos2d::Point(4, -12)};

	//auto body = PhysicsBody::createEdgePolygon(PBox, 4,PHYSICSBODY_MATERIAL_DEFAULT,0.5f);
	auto body = PhysicsBody::createPolygon(PBox, 8);
	body->setEnable(true);
	body->setDynamic(true);
	body->setGravityEnable(true);
	body->setRotationEnable(false);
	body->setVelocityLimit(30.0);
	body->setCategoryBitmask(static_cast<int>(Stage::TileType::PLAYER));
	//BLOCKS??Æ‚ÌÚG????????????ON
	//body->setCollisionBitmask(static_cast<int>(Stage::TileType::BLOCKS));
	body->setCollisionBitmask(static_cast<int>(Stage::TileType::NONE));
	body->setContactTestBitmask(static_cast<int>(Stage::TileType::BLOCKS));

	//body->setContactTestBitmask(INT_MAX);

	this->setPhysicsBody(body);

	this->setAnchorPoint(Vec2::ANCHOR_MIDDLE);
	this->scheduleUpdate();
	return true;
}

/*
Magic* Player::upDownMirrorEffect()
{
	cocos2d::Size winSize = Director::getInstance()->getWinSize();
	magic = Magic::create();
	magic->setAnchorPoint(Vec2::ANCHOR_BOTTOM_LEFT);
	magic->setScaleX(16 * 24);

	ScaleTo* whiteUpScale = ScaleTo::create(0.2, 384, winSize.height);
	ScaleTo* whiteDownScale = ScaleTo::create(0.2, 384, this->getPositionY()-winSize.height);
	MoveTo* goUp = MoveTo::create(0.2, Vec2(0, winSize.height));
	MoveTo* goDown = MoveTo::create(0.2, Vec2(0, -winSize.height));
	Sequence* upMagic = Sequence::create(whiteUpScale, goUp, RemoveSelf::create(), NULL);
	Sequence* downMagic = Sequence::create(whiteDownScale, goDown, RemoveSelf::create(), NULL);

	auto clipping = ClippingNode::create();
	clipping->setStencil(magic);
	clipping->setInverted(false);
	clipping->setAlphaThreshold(1.0);
	addChild(clipping);

	if (upFlag == true)
	{
		magic->runAction(upMagic);

		auto reflex = Sprite::create("graphics/reflex.png");
		reflex->getTexture()->setAliasTexParameters();
		reflex->setAnchorPoint(Vec2::ANCHOR_BOTTOM_LEFT);

		clipping->addChild(reflex);
	}

	else
	{
		magic->runAction(downMagic);

		auto reflex = Sprite::create("graphics/reflex.png");
		reflex->getTexture()->setAliasTexParameters();
		reflex->setAnchorPoint(Vec2::ANCHOR_TOP_LEFT);

		clipping->addChild(reflex);
	}

	return magic;
}

Magic* Player::sideMirrorEffect()
{
	cocos2d::Size winSize = Director::getInstance()->getWinSize();
	magic = Magic::create();
	magic->setAnchorPoint(Vec2::ANCHOR_BOTTOM_LEFT);
	magic->setScaleY(16 * 14);

	ScaleTo* whiteRightScale = ScaleTo::create(0.2, winSize.width, 244);
	ScaleTo* whiteLeftScale = ScaleTo::create(0.2, this->getPositionX() - winSize.width, 244);
	MoveTo* goRight = MoveTo::create(0.2, Vec2(winSize.width, 0));
	MoveTo* goLeft = MoveTo::create(0.2, Vec2(-winSize.width, 0));
	Sequence* RightMagic = Sequence::create(whiteRightScale, goRight, RemoveSelf::create(), NULL);
	Sequence* LeftMagic = Sequence::create(whiteLeftScale, goLeft, RemoveSelf::create(), NULL);

	auto flip = FlipX::create(true);
	auto flipback = FlipX::create(false);
	Sequence* LreflexMove = Sequence::create(flip,DelayTime::create(0.1), goLeft, RemoveSelf::create(), NULL);
	Sequence* RreflexMove = Sequence::create(flipback, DelayTime::create(0.1), goRight, RemoveSelf::create(), NULL);

	auto clipping = ClippingNode::create();
	clipping->setStencil(magic);
	clipping->setInverted(false);
	clipping->setAlphaThreshold(1.0);
	addChild(clipping);

	if (rightFlag == true)
	{
		magic->runAction(RightMagic);

		auto reflex = Sprite::create("graphics/reflex.png");
		reflex->getTexture()->setAliasTexParameters();
		reflex->setAnchorPoint(Vec2::ANCHOR_BOTTOM_LEFT);
		reflex->runAction(RreflexMove);

		clipping->addChild(reflex);
	}

	else
	{
		magic->runAction(LeftMagic);

		auto reflex = Sprite::create("graphics/reflex.png");
		reflex->getTexture()->setAliasTexParameters();
		reflex->setAnchorPoint(Vec2::ANCHOR_BOTTOM_RIGHT);
		reflex->runAction(LreflexMove);

		clipping->addChild(reflex);
	}

	return magic;
}
*/
// 0~2??ÌƒA??j??????[??V??????????????Ä????????éƒ??\??b??h(0??Ê????A1??????A2????)
//void??^????Player::playAnimation(int index)??Ö????????ì¬
void Player::playAnimation(int index)
{

	//?????????Ï??indexCheck??Æ•Ï??index?????????????????????????
	if (indexCheck == index) {
		//??????????ÅŠÖ????Ì????????????I????????????
		return;
	}

	// ??A??j??????[??V??????????p??Ìƒ^??O??????Å’????l??Å’????`
	const int ACTION_TAG = 999; // ??D??????È??

	// ??????ÉƒA??j??????[??V??????????????????????Ä‚????????????~??ß‚??
	// ??A??j??????[??V??????????É‚Í‘S????999??Ìƒ^??O??????t??????Ä‚????Í‚????È‚Ì‚ÅA??d??????????È‚????æ‚¤??É~??ß‚??
	this->stopActionByTag(ACTION_TAG);

	// cocos2d::Size??^????frameSize??Ï????Å•\??????????é‚©??í‚¸??????????ÌƒX??v??????C??g??ÌƒT??C??Y??????w??????H
	//cocos2d::Size(frameSize.width, frameSize.height)??É‚????ê‚¼????16.0??????????????????Ä‚????????B??^????float
	auto frameSize = cocos2d::Size(16.0, 24.0);

	//??H
	//??X??v??????C??g????X????W0??AY????W0(????????)??????????A16x16??????Ø‚????o??????H
	//cocos2d::Rect????x,y,width,height????4??Â‚????Æ‚????????B??????`??Æ‚????????Ó–??
	this->setTextureRect(cocos2d::Rect(0, 0, frameSize.width, frameSize.height));

	//SpriteFrame*??Æ‚????????e??????v??????[??g????frames??Æ‚????????z??????????éŒ¾
	Vector<SpriteFrame*> frames;

	//??Ï??i??????éŒ¾??A0??Å????ú‰»‚µi????FRAME_COUNT??????????Å‚????é??A??Ï??i????1???????Z????{}??????Ì????????????s??????????[??v
	//i????FRAME_COUNT??????????Å‚È‚????È‚?????????Éƒ????[??v??ğ”²‚??????
	for (int i = 0; i < FRAME_COUNT; ++i)
	{
		// index??Ì’l??É‚???????y????W??????Ï‚??????
		//cocos2d::SpriteFrame??^??Ìƒ|??C??????g??Ï??frame??????éŒ¾
		//??æ‘œkawaz_shooting.png??????Ç‚İAframeSize.width????i?????2??R??}??A??j??????[??V??????????Ìƒ????[??v
		//index????16(frameSize.height??Ì’l)???????A??A??j??????[??V??????????????Ø‚????Ö‚??
		//frameSize.width????frameSize.height??Å•\??????????????æ‘œ??Ì‘å‚«??????????w??????H
		auto frame = SpriteFrame::create("graphics/luk_sprite.png", cocos2d::Rect(frameSize.width * i, index * frameSize.height, frameSize.width, frameSize.height));

		//??z????frames??ÌI????????????frame??Ì’l??????}????????????
		frames.pushBack(frame);
	}
	auto frame = SpriteFrame::create("graphics/luk_sprite.png", cocos2d::Rect(frameSize.width, index * frameSize.height, frameSize.width, frameSize.height));
	frames.pushBack(frame);

	if (index == 2)
	{
		frames.clear();
		auto frame = SpriteFrame::create("graphics/luk_sprite.png", cocos2d::Rect(frameSize.width, 2 * frameSize.height, frameSize.width, frameSize.height));
		frames.pushBack(frame);
	}
	else if (index == 3)
	{
		frames.clear();
		auto frame = SpriteFrame::create("graphics/luk_sprite.png", cocos2d::Rect(frameSize.width * 2, 2 * frameSize.height, frameSize.width, frameSize.height));
		frames.pushBack(frame);
	}
	else if (index == 4)
	{
		frames.clear();
		auto frame = SpriteFrame::create("graphics/luk_sprite.png", cocos2d::Rect(0, 3 * frameSize.height, frameSize.width, frameSize.height));
		frames.pushBack(frame);
	}
	else if (index == 5)
	{
		frames.clear();
		auto frame = SpriteFrame::create("graphics/luk_sprite.png", cocos2d::Rect(frameSize.width, 3 * frameSize.height, frameSize.width, frameSize.height));
		frames.pushBack(frame);
	}
	else if (index == 6)
	{
		frames.clear();
		auto frame = SpriteFrame::create("graphics/luk_sprite.png", cocos2d::Rect(frameSize.width * 2, 3 * frameSize.height, frameSize.width, frameSize.height));
		frames.pushBack(frame);
	}
	else if (index == 7)
	{
		frames.clear();
		for (int i = 0; i <= FRAME_COUNT; ++i)
		{
			auto frame = SpriteFrame::create("graphics/luk_sprite.png", cocos2d::Rect(frameSize.width * i, 96, frameSize.width, frameSize.height));
			frames.pushBack(frame);
		}
	}

	//cocos2d::Animation??^??Ìƒ|??C??????^??Ï??animation??????éŒ¾
	//??z????frames??????????????????Ä‚?????Û‚??????????With??È‚ñ‚¿‚????ç‚ª??æ‚­??í‚©??????È‚??
	auto animation = Animation::createWithSpriteFrames(frames);
	if (index == 0)
	{
		animation->setDelayPerUnit(0.2);
	}
	else if (index == 7)
	{
		animation->setDelayPerUnit(0.3);
	}
	else
	{
		animation->setDelayPerUnit(0.1);
	}
	if (index != 7)
	{
		//cocos2d::RepeatForever??^??Ìƒ|??C??????^??Ï??animate??????éŒ¾??@??È‚ñ‚©ˆÅ‚?Û‚??
		//Animate::create(animation)????animation??ÅéŒ¾??????ê‚½2??R??}??A??j??????ğ¶????????Ä‚????Æ‚?????
		//RepeatForever??Í????????????????A??j??????[??V??????????????ğ–³Œ??ÉŒJ??????Ô‚??
		auto animate = RepeatForever::create(Animate::create(animation));

		//??|??C??????^??Ï??animate????ACTION_TAG??Æ‚????????^??O??????İ’??
		animate->setTag(ACTION_TAG);

		//animate??Æ‚????????A??N??V??????????ğ‘–‚ç‚¹????
		this->runAction(animate);
	}
	else
	{
		auto clearAnimate = Animate::create(animation);

		clearAnimate->setTag(ACTION_TAG);
		this->runAction(clearAnimate);
	}

	//indexCheck????index??Ì’l????????????????????
	indexCheck = index;

}
